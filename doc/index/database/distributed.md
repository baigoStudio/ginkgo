## 分布式数据库

`v0.3.0` 新增

数据访问层支持分布式数据库，要启用分布式数据库，可以将数据库配置的 `host` 参数配置为数组，例如：

``` php
return array(
  // 数据库类型
  'type'    => 'mysql',
  // 服务器地址
  'host'    => array( '192.168.1.1', '192.168.1.2' ),
  // 数据库名
  'dbname'  => 'ginkgo',
  // 数据库用户名
  'user'    => 'root',
  // 数据库密码
  'pass'    => '123456',
  // 数据库连接端口
  'port'    => '',
  // 数据库编码默认采用 utf8
  'charset' => 'utf8',
  // 数据库表前缀
  'prefix'  => 'ginkgo_',
  // 数据库调试模式
  'debug'   => false,
);
```

要启用分布式数据库，`host` 参数是关键，`host` 的个数决定了分布式数据库的数量，默认情况下第一个地址就是主服务器。主从服务器支持设置不同的连接参数，除 `host` 参数外，下列参数也支持数组：

| 参数 |
| - |
| dbname |
| user |
| pass |
| port |
| charset |

如果主从服务器的上述参数一致的话，只需要设置一个，对于不同的参数，可以分别设置，例如：

``` php
return array(
  // 数据库类型
  'type'    => 'mysql',
  // 服务器地址
  'host'    => array( '192.168.1.1', '192.168.1.2', '192.168.1.3' ),
  // 数据库名
  'dbname'  => 'ginkgo',
  // 数据库用户名
  'user'    => 'root',
  // 数据库密码
  'pass'    => array( '123456', 'abcde', 'abcde' ),
  // 数据库连接端口
  'port'    => '',
  // 数据库编码默认采用 utf8
  'charset' => 'utf8',
  // 数据库表前缀
  'prefix'  => 'ginkgo_',
  // 数据库调试模式
  'debug'   => false,
);
```

> 重要提示：参数或者全部相同，或者每个都设置，否则会出现错误。

----------

#### 读写分离

分布式数据库支持读写分离，下列设置可以开启读写分离：

``` php
'rw_separate' => true,
```

在读写分离的环境下，默认第一个数据库是主服务器，负责写入，如果设置了 `master_num` 参数，则为多个主服务器（每次随机连接一个）。其它的地址都是从数据库，负责读取，数量不限。

每次连接从服务器进行读操作的时候，系统会随机选择一个。如果不希望随机，或者特殊情况下部分从服务器不可用，可以设置 `slave_no` 参数来指定服务器，`slave_no` 指定的序号表示 `host` 参数中数据库的序号，从 <kbd>0</kbd> 开始。

在进行 `CURD` 操作时，系统会自动判断当前是读操作还是写操作，并自动连接服务器。使用原生 SQL 的默认规则为：写操作必须用 `exec()` 方法，读操作必须用 `query()` 方法。

> 分布式数据库的数据同步工作不在框架实现，需要数据库自行实现。在大数据量或者特殊的情况下写入数据后可能会存在同步延迟，此时可以调用 `master()` 方法进行主库查询操作。

----------

#### 主库读取

某些情况下，需要直接从主库读取，例如刚写入数据，从库数据还没来得及同步，可以使用如下方式：

``` php
$data = array(
  'name' => 'ginkgo',
);

Db::table('user')
  ->where('id', '=', 1)
  ->update($data);

Db::table('user')
  ->master()
  ->where('id', '=', 1)
  ->find();
```

> 在实际生产环境中，很多云主机的数据库分布式实现机制会有所区别，通常会采用如下方式：

> * 提供了写IP和读IP（虚拟IP），进行数据库的读写分离操作；
> * 始终保持同一个IP连接数据库，内部会进行读写分离IP调度（阿里云就是采用该方式）。
